#!/bin/bash

set -o errexit
set -o pipefail

dataFiles="$1"
description="$2"
numIterations="$3"
numFolds="$4"
debug="$5"
fsAlgos="$6"
outFeaturesFile="$7"
outSummarizedFeaturesFile="$8"
outBenchmarkFile="$9"
outLogFile="${10}"

tmpDir=$(mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir')

function cleanup {
  rm -rf $tmpDir
}

cleanup

if [[ "$outLogFile" == "" ]]
then
  echo An output log file must be specified.
  exit 1
fi

rm -f "$outLogFile"

for iteration in $(seq 1 $numIterations)
do
  outDir=$tmpDir/$iteration
  mkdir -p $outDir

  if [[ "$outFeaturesFile" == "" ]]
  then
    outFeaturesFileIteration=
  else
    outFeaturesFileIteration=$outDir/outfeatures
  fi
  if [[ "$outBenchmarkFile" == "" ]]
  then
    outBenchmarkFileIteration=
  else
    outBenchmarkFileIteration=$outDir/outbench
  fi

  scripts/featureselection "$dataFiles" "$description" "$numFolds" "$debug" "$fsAlgos" "$outFeaturesFileIteration" "" "$outBenchmarkFileIteration" crossvalidation $iteration 2>&1 | tee -a "$outLogFile"
done

python scripts/CombineCrossValidationIterations.py "$tmpDir/*/outfeatures,$tmpDir/*/outbench" "$outFeaturesFile,$outBenchmarkFile" 2>&1 | tee -a "$outLogFile"

source scripts/helper
Rscript --vanilla scripts/BordaCountFeatures.R $outFeaturesFile $outSummarizedFeaturesFile 2> $errFile | tee -a "$outLogFile"
printError

cleanup

echo "Analysis successfully completed!" | tee -a "$outLogFile"
