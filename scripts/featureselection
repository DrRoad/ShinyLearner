#!/bin/bash

set -euo pipefail

source scripts/shared_functions

dataFiles="$1"
description="$2"
numIterations="$3"
verbose="$4"
fsAlgos="$5"
outFeaturesFile="$6"
outSummarizedFeaturesFile="$7"
outBenchmarkFile="$8"
validationType="$9"
randomSeed="${10}"
ohe="${11}"
tmpDir="${12}"

source scripts/setup

idFile=$tmpDir/id
classFile=$tmpDir/cl
trainTestFile=$tmpDir/tt
trainTestFile2=$tmpDir/tt2

if [[ "$validationType" == "montecarlo" ]]
then
  analysisDataFile=$tmpDir/data.gz

  echo "Preparing for analysis..."
  java -Xmx${mem} -jar shinylearner.jar RAW_DATA_FILES="$dataFiles" ANALYSIS_DATA_FILE="$analysisDataFile" DEBUG=$verbose TEMP_DIR=$tmpDir 2> /dev/null

  python scripts/ExtractSampleInfo.py "$analysisDataFile" "$description" $idFile $classFile
  python scripts/AssignTrainingTesting.py $idFile $classFile $iterationOutputHeader $trainTestFile $numIterations $randomSeed
else
  analysisDataFile="$dataFiles"
  python scripts/ExtractSampleInfo.py "$analysisDataFile" "$description" $idFile $classFile
  python scripts/AssignCrossValidation.py $idFile $classFile $iterationOutputHeader $trainTestFile $numIterations $randomSeed
fi

python scripts/AddAlgorithmScripts.py $trainTestFile "$fsAlgos" $trainTestFile2

if [[ "$ohe" == "true" ]]
then
  echo "One-hot encoding categorical data (where applicable)..."
  python scripts/OneHotEncode.py "$analysisDataFile"
fi

echo "Starting feature selection..."
java -Xmx${mem} -jar shinylearner.jar ANALYSIS_DATA_FILE="$analysisDataFile" EXPERIMENT_FILE=$trainTestFile2 OUTPUT_FEATURES_FILE_PATH="$tmpDir/of" OUTPUT_BENCHMARK_FILE_PATH="$tmpDir/ob" DEBUG=$verbose TEMP_DIR=$tmpDir 2> /dev/null

function parseOutputFile {
  if [[ "$2" != "" ]]
  then
    python scripts/ParseNonNestedResults.py $1 $iterationOutputHeader $1.sorttemp
    sortFile $1.sorttemp "-k1,1 -k2,2n -k3" "$2"
  fi
}

echo "Preparing output files..."
parseOutputFile "$tmpDir/of" "$outFeaturesFile"
parseOutputFile "$tmpDir/ob" "$outBenchmarkFile"

if [[ "$outSummarizedFeaturesFile" != "" ]]
then
  echo "Summarizing feature ranks..."
  Rscript --vanilla scripts/BordaCountFeatures.R "$outFeaturesFile" "$outSummarizedFeaturesFile" 2> $errFile
  printError $verbose $errFile
fi
